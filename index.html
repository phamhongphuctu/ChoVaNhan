function loadAppContent() {
    const currentUser = localStorage.getItem('currentUser');
    document.querySelector('main').innerHTML = `
        <div id="appContent">
            <h2>Danh sách bài đăng</h2>
            <div id="postsContainer"></div>
            
            <h2>Đăng bài mới</h2>
            <form id="postForm">
                <input type="text" id="name" placeholder="Tên" required>
                <textarea id="content" rows="4" placeholder="Nội dung" required></textarea>
                <select id="type">
                    <option value="Cho">Cho</option>
                    <option value="Nhận">Nhận</option>
                </select>
                <input type="file" id="image" accept="image/*">
                <button type="submit">Đăng bài</button>
            </form>
            <button onclick="logout()" style="margin-top: 20px; background-color: #ff4d4d;">Thoát</button>
        </div>
    `;
    loadPosts();
    document.getElementById('postForm').addEventListener('submit', handlePostFormSubmit);
}

function loadPosts() {
    const posts = JSON.parse(localStorage.getItem('posts')) || [];
    const currentUser = localStorage.getItem('currentUser');
    const postsContainer = document.getElementById('postsContainer');
    postsContainer.innerHTML = '';

    posts.forEach((post, index) => {
        const isAdmin = currentUser === 'admin';
        const div = document.createElement('div');
        div.className = 'card';
        div.style.opacity = post.completed ? '0.5' : '1';
        div.innerHTML = `
            <img src="${post.image || 'https://via.placeholder.com/100'}" alt="Image">
            <div class="card-content">
                <h3>${post.type}: ${post.name}</h3>
                <p>${post.content}</p>
                ${
                    !post.completed && isAdmin
                        ? `<button onclick="markAsCompleted(${index})">Đã giao dịch</button>
                           <button onclick="deletePost(${index})">Xóa</button>`
                        : post.completed
                        ? '<p><strong>Đã giao dịch</strong></p>'
                        : ''
                }
            </div>
        `;
        postsContainer.appendChild(div);
    });
}

function markAsCompleted(index) {
    const posts = JSON.parse(localStorage.getItem('posts')) || [];
    if (posts[index]) {
        posts[index].completed = true;
        localStorage.setItem('posts', JSON.stringify(posts));
        alert('Bài đăng đã được đánh dấu là giao dịch thành công!');
        loadPosts();
    }
}

function deletePost(index) {
    const posts = JSON.parse(localStorage.getItem('posts')) || [];
    posts.splice(index, 1);
    localStorage.setItem('posts', JSON.stringify(posts));
    loadPosts();
}

function handlePostFormSubmit(e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const type = document.getElementById('type').value;
    const content = document.getElementById('content').value;
    const imageFile = document.getElementById('image').files[0];

    const reader = new FileReader();
    reader.onload = function () {
        const imageBase64 = reader.result;

        const posts = JSON.parse(localStorage.getItem('posts')) || [];
        posts.push({ name, type, content, image: imageBase64, completed: false });
        localStorage.setItem('posts', JSON.stringify(posts));

        alert('Bài đăng đã được lưu!');
        loadPosts();
    };

    if (imageFile) {
        reader.readAsDataURL(imageFile);
    } else {
        const posts = JSON.parse(localStorage.getItem('posts')) || [];
        posts.push({ name, type, content, image: 'https://via.placeholder.com/100', completed: false });
        localStorage.setItem('posts', JSON.stringify(posts));
        alert('Bài đăng đã được lưu!');
        loadPosts();
    }

    document.getElementById('postForm').reset();
}

function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
}
